<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Every great developer you know got there by solving problems they were unqualified to solve until they actually did it."><title>Nginx配置文件全剖析 | Just Do It</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-120855082-1','auto');ga('send','pageview');
</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Nginx配置文件全剖析</h1><a id="logo" href="/.">Just Do It</a><p class="description">Every great developer you know got there by solving problems they were unqualified to solve until they actually did it.</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Nginx配置文件全剖析</h1><div class="post-meta">Jun 12, 2018</div><div class="post-content"><p>Nginx作为目前最常使用的异步框架Web服务器, 我们常常将它使用在反向代理， 负载均衡， Http缓存等应用场景。在使用Nginx的时候，我们不可避免地需要去变更NGINX的配置文件来实现我们想要的功能。对于不是很熟悉NGINX配置文件结构的人， 在打开NGINX配置文件的时候， 往往会比较茫然，不是很明白如何正确快速的入手去配置， 今天我们从NGINX的配置文件结构上进行剖析，来掌握好NGINX配置文件的经络结构， 这样后续我们在配置NGINX的时候就能更快更高效达到我们的目标。</p>
<h2 id="配置文件目录位置"><a href="#配置文件目录位置" class="headerlink" title="配置文件目录位置"></a>配置文件目录位置</h2><p>Nginx的主配置文件是nginx.conf, 它的目录位置根据安装nginx方式的不同也是不同的，我们常常可以在以下几个位置可以找到它。</p>
<ul>
<li>/etc/nginx/nginx.conf</li>
<li>/usr/local/nginx/conf/nginx.conf</li>
<li>/usr/local/etc/nginx/nginx.conf</li>
</ul>
<h2 id="上下文配置的概念"><a href="#上下文配置的概念" class="headerlink" title="上下文配置的概念"></a>上下文配置的概念</h2><p>Nginx的主配置文件是以类似树状的结构来进行组织的， 可以看到由多个“{}”包裹的配置块组装而成。在Nginx的术语中， 这些块被称之为“上下文”。每个块中包含了各自所关注场景下一些配置信息，这些上下文配置配置整体组装起来后，为Nginx提供了一个整体配置结构，并提供了一些逻辑条件帮助NGINX来判断确定在何种情况下使用其中的配置。</p>
<p>因为上下文之间可以分层嵌套，NGINX提供了指令继承配置的功能。在更大配置上下文作用域中的声明的配置指令，这个配置指令的默认值将被嵌套其中的子上下文作用域所默认继承，不过子上下文可以根据需要进行重新配置这个默认继承的配置指令值覆盖掉这个默认值的配置。</p>
<p>一些配置只能使用在一些特定类型的上下文配置中，Nginx在进行启动的时候如果发现一些配置指令配置在了错误类型的上下文中的时候，Nginx会打印出错误日志。对于什么类型的上下文配置中应该包含哪些配置，可以参考<a href="http://nginx.org/en/docs/dirindex.html" target="_blank" rel="noopener">Nginx的配置文档</a>。</p>
<h2 id="核心上下文配置"><a href="#核心上下文配置" class="headerlink" title="核心上下文配置"></a>核心上下文配置</h2><h3 id="主上下文配置（Main-Context）"><a href="#主上下文配置（Main-Context）" class="headerlink" title="主上下文配置（Main Context）"></a>主上下文配置（Main Context）</h3><p>先看下Nginx.conf一段配置内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user www-data;</span><br><span class="line">worker_processes auto;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">        worker_connections 768;</span><br><span class="line">        # multi_accept on;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以看到前三行配置，并不属于任何一个“{}”上下文块中，像这种独立于“{}“块的配置我们统一称之为主上下文配置（Main Context）。主配置的配置内容通常表示Nginx的整体的环境变量配置，这里主要放置会影响NGINX应用运行的基础配置。在这里放置的配置很多时候会向下影响到子上下文的配置，但是其中很多的配置不会被继承到，因为这些配置不能被覆盖。</p>
<blockquote>
<p>主上下文配置通常是系统级别的全局配置，如下是几个常见的栗子：</p>
<ol>
<li>运行worker进程的用户和组配置</li>
<li>运行worker的数量配置</li>
<li>保存主进程的PID文件配置</li>
<li>调整CPU affinity 和 Worker进程niceness的值</li>
<li>整个应用默认异常文件配置（可被更具体的上下文配置覆盖）</li>
</ol>
</blockquote>
<h3 id="事件上下文配置（Event-Context）"><a href="#事件上下文配置（Event-Context）" class="headerlink" title="事件上下文配置（Event Context）"></a>事件上下文配置（Event Context）</h3><p>事件上下文配置是被包含在主上下文配置中的。它通常的配置是用来设置Nginx如何在一般级别情况下处理连接。注意整个Nginx配置文件中只允许出现一个事件上下文配置。事件上下文配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">user www-data;</span><br><span class="line">worker_processes auto;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">        worker_connections 768;</span><br><span class="line">        # multi_accept on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Nginx进行连接处理时使用的是基于异步事件驱动的模型，所以在这里的上下文进行的配置是用来决定worker进程如何处理连接。在这里常见的配置是选择合适的事件驱动模型，比如我们常见的epoll, select等。其它的配置如： worker可以处理的连接数，以及当被通知有打开的连接时， 一个worker是否一次只取一个连接，还是一次性取出所有打开的连接，worker是否采用轮流的方式来响应事件。</p>
<h3 id="HTTP上下文配置-（Http-Context）"><a href="#HTTP上下文配置-（Http-Context）" class="headerlink" title="HTTP上下文配置 （Http Context）"></a>HTTP上下文配置 （Http Context）</h3><p>当我们把Nginx作为一个Web服务器和一个反向代理服务器的时候，这里的配置会是我们最常改动的位置。Http上下文配置包含了所有配置指令和其它类型的所必须的上下文配置， 这里的配置用来定义NGINX如何处理HTTP和HTTPS的请求。</p>
<p>HTTP上下文配置为事件上下文配置的兄弟节点，所以它们之间并非嵌套关系，而是并列关系。它们都是主上下文配置的儿子节点。如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">        ##</span><br><span class="line">        # Basic Settings</span><br><span class="line">        ##</span><br><span class="line"></span><br><span class="line">        sendfile on;</span><br><span class="line">        tcp_nopush on;</span><br><span class="line">        tcp_nodelay on;</span><br><span class="line">        keepalive_timeout 65;</span><br><span class="line">        types_hash_max_size 2048;</span><br><span class="line">        # server_tokens off;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>同时HTTP上下文配置中嵌套的更底层的上下文配置则会配置更具体详细的控制如何控制请求，在这个层级中的配置指令用来控制每一个virtual server(也就是server上下文配置， 后文会有介绍)上下文配置所会继承的默认配置值。在这个上下文配置以及其中嵌套的子上下文配置中有着大量的配置指令，依赖于你如何去选择要去被继承的指令配置。</p>
<p>HTTP上下文你最有可能会去变更的包含下列几种类型的配置：</p>
<ul>
<li>access_log和error_log的路径配置</li>
<li>配置文件处理的异步I/O机制（aio, sendfile, directio）</li>
<li>当错误发生的时候，Server的状态fanhui，比如错误页面的地址</li>
<li>压缩相关的配置（gzip和gzip_disable）</li>
<li>调试TCP keep alive的配置（keepalive_disable, keepalive_requests, keepalive_timeout）</li>
<li>包处理和系统调用优化配置（sendfile, tcp_nodelay, tcp_nopush）</li>
<li>剩余其它的配置等:<ul>
<li>NGINX整个应用级别访问的根目录配置和首页配置（root、index）</li>
<li>用来存储不同类型数据（server_names, types, variables）不同hash table配置的选择（<em>_hash_bucket_size, </em>_hash_max_size）</li>
<li>等等</li>
</ul>
</li>
</ul>
<blockquote>
<p>aio, sendfile, directio 这几个是在做优化场景中会采取的手法，也是面试中会经常被问到的问题，后续会出专题分开介绍。</p>
</blockquote>
<h3 id="Server上下文配置（Server-Context）"><a href="#Server上下文配置（Server-Context）" class="headerlink" title="Server上下文配置（Server Context）"></a>Server上下文配置（Server Context）</h3><p>Server上下文配置是嵌套于前面所说的Http上下文配置之中的配置， 这也是我们到现在讲述的第一个”嵌套型”上下文配置， 这也是第一个可以声明多次的上下文配置。配置结构如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    # http context</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        # first server context</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        # second server context</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>允许声明多个Server上下文配置实例的原因是，我们希望更精确的控制请求连接，每一个Server上下文配置块会对应一个虚拟的Server来负责一部分连接，你可以根据不同的需求来任意配置多个Server上下文。</p>
<p>正是因为并列的多个Server上下文配置的存在，当一个客户端请求发起请求到Nginx的时候，Nginx应该根据这多个Server上下文的配置来选择出一个最贴近此请求特征细节的Server配置实例，并按照这个Server上下文配置的来进行处理这个请求。特征细节主要包含两个方面：</p>
<ul>
<li>监听（listen）：这个Server上下文配置的会用来处理哪些ip和端口。如果一个请求过来，它的来源ip和访问的端口和这里的配置能够很好的匹配，那么这个Server上下文的配置实例就会被选上作为候选。</li>
<li>服务名称（server name）: 如果有多个Server上下文实例的listen都匹配上了，此时Nginx会去解析请求中的header头，并用这个header头来进行匹配操作。</li>
</ul>
<p>Server上下文中的很多配置指令会覆盖在Http上下文配置中的指令，比如包括日志的，文档root配置，压缩配置等等。除了使用来自Http上下文的配置指令之外，我们还可以进行配置相应请求的try_files配置，重定向的配置（rewrite,return)等等，设置变量值。</p>
<h3 id="Location上下文配置（Location-Context）"><a href="#Location上下文配置（Location-Context）" class="headerlink" title="Location上下文配置（Location Context）"></a>Location上下文配置（Location Context）</h3><p>location 的配置如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location match_modifier location_match &#123;</span><br><span class="line"></span><br><span class="line">    . . .</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一下location在nginx文档中的说明。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	location [ = | ~ | ~* | ^~ ] uri &#123; ... &#125;</span><br><span class="line">location @name &#123; ... &#125;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, location</span><br></pre></td></tr></table></figure>
<blockquote>
<p>locations是根据request请求uri进行的设置。匹配发生在将“%xx”格式的uri解码, 解析完相对路径“.”和”..”, 将相邻”/“斜线转化成一个”/“等操作之后。location的匹配定义有两种方式， 前缀匹配和正则匹配。正则匹配的制定方式是使用“~*”（大小写不敏感）或者”~”（大小写敏感）的标识符。在确定一个Location和一个请求相匹配时，nginx首先会去查验前缀匹配模式定义的location，在这些location上下文配置里面，nginx会找出匹配最长的location的上下文配置进行选择和记录，然后，NGINX再会去查验正则匹配的locations上下文配置，按照这些location上下文配置在配置文件中出现的顺序，一个个地进行正则匹配。搜索会在第一个匹配到时终止，相应的location配置会被采用。如果没有找到对应的正则表达式的location配置，前面进行前缀匹配满足的location上下文配置记录会被选择作为要被使用的location配置。</p>
</blockquote>
<p>locations上下文配置和server上下文配置由很多相似的地方。比如，location上下文配置可以被定义多个，并且每一个location配置处理单独一种特定类型的请求，并且通过一个特定的选则算法，可以将一个特定的Location上下文配置和客户端的请求进行匹配起来。</p>
<p>和server上下文配置的不同点在于，location上下文配置是嵌套于Server上下文配置中的，并且location上下文之间可以互相嵌套。嵌套的特性可以帮助我们更容易抽象请求的分类处理，比如我们可以先定义一个更笼统的location上下文配置来圈定一种类型的请求，在这种类型的请求中我们可以使用嵌套的方式再做进一步的子集类型的细分，创建额外多个不同的location上下文配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// main context</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">    # server context</span><br><span class="line"></span><br><span class="line">    location /match/criteria &#123;</span><br><span class="line"></span><br><span class="line">        # first location context</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /other/criteria &#123;</span><br><span class="line"></span><br><span class="line">        # second location context</span><br><span class="line"></span><br><span class="line">        location nested_match &#123;</span><br><span class="line"></span><br><span class="line">            # first nested location</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location other_nested &#123;</span><br><span class="line"></span><br><span class="line">            # second nested location</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结一下，server上下文的配置选择是基于请求的ip和port结合请求头中的Host属性，location则通过请求的URI地址进一步地细分请求的URI.请求的URI内容对应的是域名或者IP地址以及端口号后面的那部分内容.</p>
<p>所以，当一个客户端发起请求 <a href="http://www.example.com:80/blog" target="_blank" rel="noopener">http://www.example.com:80/blog</a> 的时候，http, <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a>, 80 用来决定选择哪一个server，当server被选择后，/blog则被用来选择哪个location会被匹配到用来做更进一步的请求的处理。</p>
<h2 id="其它的上下文配置"><a href="#其它的上下文配置" class="headerlink" title="其它的上下文配置"></a>其它的上下文配置</h2><p>上面所罗列的例子代表了nginx中最基本的上下文配置，在nginx中还存在其它很多可以配置的上下文。</p>
<h3 id="Upstream上下文配置"><a href="#Upstream上下文配置" class="headerlink" title="Upstream上下文配置"></a>Upstream上下文配置</h3><p>Upstream上下文配置主要用于NGINX的负责均衡能力的配置，先看一下Upstream上下文配置的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    # http context</span><br><span class="line"></span><br><span class="line">    upstream upstream_name &#123;</span><br><span class="line"></span><br><span class="line">        # upstream context</span><br><span class="line"></span><br><span class="line">        server proxy_server1;</span><br><span class="line">        server proxy_server2;</span><br><span class="line"></span><br><span class="line">        . . .</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        # server context</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Upstream上下文配置定义了NGINX可以代理请求的服务器池，当我们需要配置各种代理时，就会使用到这个上下文配置。Upstream上下文配置嵌套于Http上下文配置中，和Server上下文配置并列。Upstream上下文配置定义的服务器池可以被Server上下文配置或者Location配置所引用，用于将某种确定类型的请求传递给Upstream上下文配置的服务器池。</p>
<h3 id="If上下文配置"><a href="#If上下文配置" class="headerlink" title="If上下文配置"></a>If上下文配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	if (condition) &#123; ... &#125;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, location</span><br></pre></td></tr></table></figure>
<p>If上下文的配置用来建立在其中定义的指令的条件处理。就像常规编程语言中的if一样，NGINX中的ifc的condition的判断条件为true的时候，“{}”其中的命令会被执行，请求则会被赋值if指令中包含的内容。If上下文配置中可以配置的指令，则继承来自if上下文的父上下文。</p>
<p>If上下文配置中的condition有以下几种类型：</p>
<ul>
<li>一个定义的变量。当这个变量为空string或者值为0的时候，这个condition的值会变回false</li>
</ul>
<blockquote>
<p>在版本1.0.1之前，任何以“0”开头的string condition都会被认为是一个 false 值</p>
</blockquote>
<ul>
<li>使用操作符“=”或者“!=”比较变量和string的值</li>
<li>判断一个变量是否符合正则表达式（~表示大小写敏感，~<em>表示大小写不敏感）。同时正则表达式可以包含captures(正则表达式中group概念)，captures可以在后续以（$1…$9作为引用的方式来使用）。非操作符如”!~”和“!~</em>”也可以被使用。如果正则表达式配置中包含了”}“或者”;“字符，整个表达式应该被双引号所包裹</li>
<li>使用”-f”和”!-f“判断一个文件是否存在</li>
<li>使用”-d”和”!-d”判断一个目录是否存在</li>
<li>使用”-e”和”!-e”判断一个文件，目录，软连接是否存在</li>
<li>使用”-x”和”!-x”检查一个可执行文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">if ($http_user_agent ~ MSIE) &#123;</span><br><span class="line">    rewrite ^(.*)$ /msie/$1 break;</span><br><span class="line">&#125;</span><br><span class="line">// 单独解释一下下面的正则</span><br><span class="line">// 括号中的?: 表示正则表达式不会捕捉这个括号中的内容单独作为一个group，比如 “id=([^;]+)(?:;|$)”中的捕捉后分组数为1个</span><br><span class="line">// (:|$) 表示 “冒号”或者“以空为结尾”</span><br><span class="line">if ($http_cookie ~* &quot;id=([^;]+)(?:;|$)&quot;) &#123;</span><br><span class="line">    set $id $1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($request_method = POST) &#123;</span><br><span class="line">    return 405;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($slow) &#123;</span><br><span class="line">    limit_rate 10k;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($invalid_referer) &#123;</span><br><span class="line">    return 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>If上下文配置的错误使用往往会带来意向不到的后果，参见文章<a href="https://www.nginx.com/resources/wiki/start/topics/depth/ifisevil/" target="_blank" rel="noopener">If is evil</a>,我们在使用的时候，只需要谨记，if不应该应用于大部分形式下的条件执行，在if上下文配置中可以正常使用的是（return）和（rewrite … last;）指令，所以if指令最经常应该使用的场景是用来决定是否需要rewrite或者return操作，这些配置往往出现于location上下文配置中，所以最常见的格式如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// main context</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    # http context</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        # server context</span><br><span class="line"></span><br><span class="line">        location location_match &#123;</span><br><span class="line"></span><br><span class="line">            # location context</span><br><span class="line"></span><br><span class="line">            if (test_condition) &#123;</span><br><span class="line"></span><br><span class="line">                # if context</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Limit-except上下文配置"><a href="#Limit-except上下文配置" class="headerlink" title="Limit_except上下文配置"></a>Limit_except上下文配置</h3><p>Limit_except上下文配置嵌套于Location context中，用来控制request请求的HTTP method。举个例子，比如只允许某种特定来源的客户端可以请求POST，其他客户端则只允许GET HEAD, 那么我们就可以这样配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">. . .</span><br><span class="line"></span><br><span class="line">// server or location context</span><br><span class="line"></span><br><span class="line">location /restricted-write &#123;</span><br><span class="line"></span><br><span class="line">    # location context</span><br><span class="line"></span><br><span class="line">    limit_except GET HEAD &#123;</span><br><span class="line"></span><br><span class="line">        # limit_except context</span><br><span class="line"></span><br><span class="line">        allow 192.168.1.1/24;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的配置结果是，允许任何的客户端可以发送GET,HEAD请求，同时允许子网为（192.168.1.1/24）的客户端使用其他的请求METHOD.</p>
<blockquote>
<p>本文主要总结翻译来源于作者 Justin Ellingwood 的文章，并参考NGINX文档的部分说明。 <a href="https://www.digitalocean.com/community/tutorials/understanding-the-nginx-configuration-file-structure-and-configuration-contexts" target="_blank" rel="noopener">Understanding the Nginx Configuration File Structure and Configuration Contexts</a></p>
</blockquote>
</div><div class="tags"><a href="/tags/nginx/">nginx</a></div><div class="post-nav"><a class="pre" href="/2018/Java_SSL_1/">Java_SSL详解(一)</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.0"><script src="/js/gitment.browser.js?v=0.0.0"></script><script>var gitment = new Gitment({
  owner: 'geek-frio',
  repo: 'geek-frio.github.io',
  oauth: {
    client_id: 'c932c463c47bd6dfa128',
    client_secret: '75354bbd7b056095ef7e38e05fc72b6a9a9bbec7',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.geekiknow.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/SSL/" style="font-size: 15px;">SSL</a> <a href="/tags/Openssl/" style="font-size: 15px;">Openssl</a> <a href="/tags/KeyStore/" style="font-size: 15px;">KeyStore</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/Java_SSL_2/">Java_SSL详解(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/Java_SSL_1/">Java_SSL详解(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/nginx_config/">Nginx配置文件全剖析</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Just Do It.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>